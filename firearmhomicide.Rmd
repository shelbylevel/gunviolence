---
title: "Firearm Homicide"
author: "Shelby Level"
format: 
  html:
    theme: united
    font: Georgia
    fontsize: 1.0em
self-contained: true
editor_options: 
  chunk_output_type: console
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, echo = TRUE, warning = FALSE, message = FALSE)
```

# Background 
The OHIO Alliance for Population Health (OAPH) is a statewide collaborative focused on improving the health of all Ohioans by solving the most complex and pressing population health concerns across the state. In line with OAPHâ€™s overarching mission, this report aims to identify disparities in gun violence mortality among Ohioans and consider how these disparities can be addressed to improve health and wellbeing across the state. 

# Methodology 
This report examines firearm homicide deaths across national and state levels over an extended period of time.  
 
CDC WONDER collects and maintains data regarding deaths and their causes. All data were extracted from CDC WONDER using provisional or final mortality data.  
 
All maps, graphs, and other figures for the United States and Ohio that are presented in this report were produced using R, RStudio, ggplot2, sf, tidyverse, and tidycensus. 

# Key Findings 
In 2022, firearms accounted for 79.1% of all homicide deaths in the United States 
In 2022, firearms accounted for 79.4% of all homicide deaths in Ohio 
In the past 10 years (2013-2022), homicide deaths by firearms have increased 66.9% 
Since 1999, homicide deaths by firearm have increased 52.5%  
In 2022 Ohio ranked 32 (out of 51 states, with rank 1 indicating the lowest rate) in firearm homicide mortality with a reported rate of 6.3 deaths per 100,000 population, 6.8% higher than the national average 
Americans ages 20-24 experience the highest rates of gun violence mortality  
Ohioans ages 20-24 experience the highest rates of gun violence mortality  
In 2022, men were over five times as likely to be killed by gun violence than women 

```{r loading packages}
library(tidyverse)
library(stringr)
library(scales)
library(zoo)
library(sjmisc)
library(janitor)
library(dplyr)
library(tidycensus)
library(tigris)
library(sf)
library(dplyr)
library(classInt)
```

```{r census geometry data}
census_api_key('e91d231563691e6bea782a7dbafe82616924d422')

state <- get_acs(
  geography = "state",
  variables = "B01001_001",
  year = 2019,
  survey = "acs1",
  geometry = TRUE,
  resolution = "20m"
) %>%
  shift_geometry()

county <- get_acs(
  geography = "county",
  variables = c("B01001_001"),
  year = 2019,
  geometry = TRUE,
  resolution ="20m",
) %>%
  shift_geometry()

state %>% mutate(GEOID=as.integer(GEOID)) -> state
state %>% filter(NAME!="Puerto Rico") -> state
county %>% mutate(GEOID=as.integer(GEOID)) -> county

```

```{r 2022 national map by state}
#Import homicide data set
read.delim(file='US.AllFirearmHomicide.State.2022.txt') -> homicide

#Create calculated crude rate variable
homicide %>% mutate(Rate=(Deaths/Population)*100000) -> homicide

#Clean up data
homicide %>% filter(Notes=='') -> homicide
homicide = subset(homicide,select=-c(Notes)) 
homicide %>% rename(GEOID=Residence.State.Code) -> homicide

left_join(state,homicide, by='GEOID') -> homicide

#Create data breaks
breaks_j <- classIntervals(c(min(homicide$Rate),       
                             homicide$Rate),n=3,        
                           style="quantile")              

homicide <- mutate(homicide,Breaks=cut(Rate,breaks_j$brks,include.lowest=TRUE))

#Change legend category labels based on breaks
c('1.2 - 3.2','3.3 - 6.3','6.4 - 21') -> legend.labels

#Create map
ggplot() +
  
  ggtitle("Firearm Homicide Deaths by State, 2022") +
  
  geom_sf(data = homicide, aes(fill = Breaks), color = "black",size=.4, alpha=1) +
  
  scale_fill_manual(values=c("#BFCEDB",
                             
                             "#6084A6",
                             
                             "#003A70"), na.value = "white", drop = FALSE, name="Rate per 100,000 population", label=legend.labels) +
  
  
  #geom_sf_text(data=state,aes(label= Code), color = "black", size = 2.5, vjust = -.5) +
  #geom_sf_text(data=State,aes(label= round(Rate,2)), color = "black", size = 2.5, vjust = 1.2) +
  
  theme_void() +
  
  theme(text = element_text(family = 'Georgia'),
        plot.title = element_text(size = 20, color = '#004023', hjust = .5, face='bold'),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  theme(legend.position = 'bottom')
```

```{r 2018-22 national map by state}
read.delim(file='US.AllFirearmHomicide.State.2018-22.txt') -> homicide

homicide %>% mutate(Rate=(Deaths/Population)*100000) -> homicide

homicide %>% filter(Notes=='') -> homicide
homicide = subset(homicide,select=-c(Notes)) 
homicide %>% rename(GEOID=Residence.State.Code) -> homicide

left_join(state,homicide, by='GEOID') -> homicide

#Create data breaks
breaks_j <- classIntervals(c(min(homicide$Rate),       
                             homicide$Rate),n=3,        
                           style="quantile")              

homicide <- mutate(homicide,Breaks=cut(Rate,breaks_j$brks,include.lowest=TRUE))

#Change legend category labels based on breaks
c('0.9 - 2.6','2.7 - 6.0','6.1 - 20.5') -> legend.labels

#Create map
ggplot() +
  
  ggtitle("Firearm Homicide Deaths by State, 2018-2022") +
  
  geom_sf(data = homicide, aes(fill = Breaks), color = "black",size=.4, alpha=1) +
  
  scale_fill_manual(values=c("#BFCEDB",
                             
                             "#6084A6",
                             
                             "#003A70"), na.value = "white", drop = FALSE, name="Rate per 100,000 population", label=legend.labels) +
  
  #geom_sf_text(data=State,aes(label= Code), color = "black", size = 2.5, vjust = -.5) +
  #geom_sf_text(data=State,aes(label= round(Rate,2)), color = "black", size = 2.5, vjust = 1.2) +
  
  theme_void() +
  
  theme(text = element_text(family = 'Georgia'),
        plot.title = element_text(size = 19, color = '#004023', hjust = .5, face='bold'),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  theme(legend.position = 'bottom')
```

```{r 2013-17 national map by state}
read.delim(file='US.AllFirearmHomicide.State.2013-17.txt') -> homicide

homicide %>% mutate(Rate=(Deaths/Population)*100000) -> homicide

homicide %>% filter(Notes=='') -> homicide
homicide = subset(homicide,select=-c(Notes)) 
homicide %>% rename(GEOID=State.Code) -> homicide

left_join(state,homicide, by='GEOID') -> homicide

#Create data breaks
breaks_j <- classIntervals(c(min(homicide$Rate),       
                             homicide$Rate),n=3,        
                           style="quantile")              

homicide <- mutate(homicide,Breaks=cut(Rate,breaks_j$brks,include.lowest=TRUE))

#Change legend category labels based on breaks
c('0.6 - 1.9','2.0 - 4.4','4.5 - 12.6') -> legend.labels

#Create map
ggplot() +
  
  ggtitle("Firearm Homicide Deaths by State, 2013-2017") +
  
  geom_sf(data = homicide, aes(fill = Breaks), color = "black",size=.4, alpha=1) +
  
  scale_fill_manual(values=c("#BFCEDB",
                             
                             "#6084A6",
                             
                             "#003A70"), na.value = "white", drop = FALSE, name="Rate per 100,000 population", label=legend.labels) +
  
  #geom_sf_text(data=State,aes(label= Code), color = "black", size = 2.5, vjust = -.5) +
  #geom_sf_text(data=State,aes(label= round(Rate,2)), color = "black", size = 2.5, vjust = 1.2) +
  
  theme_void() +
  
  theme(text = element_text(family = 'Georgia'),
        plot.title = element_text(size = 19, color = '#004023', hjust = .5, face='bold'),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  theme(legend.position = 'bottom')
```

```{r us time series line chart 1999-2022}
#Import 1999-2020 homicide data set
read.delim(file='US.AllFirearmHomicide.Year.1999-2020.txt') -> homicide
homicide %>% filter(Notes=='') -> homicide

#Import 2021-22 homicide data set
read.delim(file='US.AllFirearmHomicide.Year.2021-22.txt') -> homicide2
homicide2 %>% filter(Notes=='') -> homicide2

#Combine datasets
rbind(homicide,homicide2) -> homicide
homicide = subset(homicide,select=-c(Notes)) 

#Create calculated crude rate variable
homicide %>% mutate(Rate=(Deaths/Population)*100000) -> homicide

#Create plot
ggplot(homicide, aes(x=Year.Code,y=Rate)) +
  
  ggtitle("U.S. Firearm Homicide Deaths by Year \n 1999 - 2022") +
  
  #Show trend line (smoothed data)
  geom_smooth(color="#003a70",span=0.75, 
  se=TRUE, size=1,fill="gray85") +  
  
  geom_col(fill="#00694e",alpha=.85) + 
  
  geom_text(aes(label= round(Rate, 1)), size=3.3, color ="black", family='Georgia', fontface='bold', vjust=1.75) +
  
  
  labs(caption='', y="Rate per 100,000 Population", x=NULL, size=15) +
  
  scale_y_continuous(labels = comma) +
  #  limits = c(MIN, MAX).
  
  scale_x_continuous(limits = c(1998, 2023), 
                     breaks = c(1999,2001,2003,2005,2007,2009,2011,2013,2015,2017,2019,2021)) +
  
  #One theme (title left, only vertical background lines)  
  #theme_minimal()+theme(axis.title.y=element_text(size=10,colour="gray40")) +
  #theme(axis.title.x=element_text(size=10,colour="gray40")) +
  #theme(axis.ticks.x = element_line(size = .03), panel.grid.minor = element_blank(),
          #     panel.grid.major.y = element_line( size=.15, color="gray10", linetype = 'dotdash'),
          #   panel.grid.major.x = element_blank(),
   #axis.ticks.length=unit(1,"cm")) +
  #theme(legend.position = 'none')
  
theme_minimal() +
  theme(text = element_text(family = 'Georgia')) +
  theme(plot.title=element_text(size = 30, color = '#003A70', hjust = 0, face='bold')) +
  theme(axis.text.x = element_text(color="black", size=11, vjust=8),
        axis.text.y = element_text(color="black", size=11, hjust=2)) +
  theme(panel.grid.major.y = element_line( size=.3, color="gray40", linetype = 'solid'),
        panel.grid.minor.y = element_line( size=.3, color="gray80", linetype = 'solid'),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  theme(legend.position = 'none')
```

```{r}

```

